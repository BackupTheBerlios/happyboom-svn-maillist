<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Happyboom-svn] r245 - in haypo/hachoir: . plugins
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/happyboom-svn/2005-November/index.html" >
   <LINK REL="made" HREF="mailto:happyboom-svn%40lists.berlios.de?Subject=Re%3A%20%5BHappyboom-svn%5D%20r245%20-%20in%20haypo/hachoir%3A%20.%20plugins&In-Reply-To=%3C200511020321.jA23LEYg004066%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000151.html">
   <LINK REL="Next"  HREF="000153.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Happyboom-svn] r245 - in haypo/hachoir: . plugins</H1>
    <B>Victor STINNER at BerliOS</B> 
    <A HREF="mailto:happyboom-svn%40lists.berlios.de?Subject=Re%3A%20%5BHappyboom-svn%5D%20r245%20-%20in%20haypo/hachoir%3A%20.%20plugins&In-Reply-To=%3C200511020321.jA23LEYg004066%40sheep.berlios.de%3E"
       TITLE="[Happyboom-svn] r245 - in haypo/hachoir: . plugins">haypo at berlios.de
       </A><BR>
    <I>Wed Nov  2 04:21:14 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000151.html">[Happyboom-svn] r244 - in haypo/hachoir: . plugins
</A></li>
        <LI>Next message: <A HREF="000153.html">[Happyboom-svn] r246 - in haypo/hachoir: . plugins
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#152">[ date ]</a>
              <a href="thread.html#152">[ thread ]</a>
              <a href="subject.html#152">[ subject ]</a>
              <a href="author.html#152">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: haypo
Date: 2005-11-02 04:21:07 +0100 (Wed, 02 Nov 2005)
New Revision: 245

Added:
   haypo/hachoir/export.template
   haypo/hachoir/plugins/gzip.py
Modified:
   haypo/hachoir/chunk.py
   haypo/hachoir/filter.py
   haypo/hachoir/hachoir.glade
   haypo/hachoir/hachoir.py
   haypo/hachoir/hachoir_class.py
   haypo/hachoir/plugins/gif.py
   haypo/hachoir/plugins/png.py
   haypo/hachoir/plugins/tar.py
   haypo/hachoir/plugins/zip.py
   haypo/hachoir/tools.py
   haypo/hachoir/ui_popup.py
   haypo/hachoir/ui_window.py
   haypo/hachoir/user_filter.py
Log:
New features :
- Export a filter to python script
- Load a python script when loading
- Each chunk can have it's post-process code (used to display)


Modified: haypo/hachoir/chunk.py
===================================================================
--- haypo/hachoir/chunk.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/chunk.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -1,9 +1,9 @@
 import struct
 import re
 import types
-import string
-from format import checkFormat
+from format import checkFormat, splitFormat
 from error import error
+from tools import convertDataToPrintableString
 
 class Chunk(object):
     def __init__(self, id, description, stream, addr, size, parent):
@@ -13,25 +13,35 @@
         self._addr = addr
         self._parent = parent
         self._stream = stream
+        self.post_process = None
+        self.display = None
 
+    def postProcess(self):        
+        if self.post_process != None:
+            self.display = self.post_process(self)
+
+    def getFormat(self):
+        return self.__class__
+
     def update(self):
-        raise Exception(&quot;Chunk of type %s doesn't implement the method update()!&quot; % self.__class__)
+        self.display = None
+        self.postProcess()
 
     def __str__(self):
         return &quot;Chunk(%s) &lt;addr=%s, size=%s, id=%s, description=%s&gt;&quot; % \
             (self.__class__, self._addr, self.size, self.id, self.description)
         
-    def getRawData(self, max_size=None):
-        return None
-        
     def getStream(self):
         return self._stream
 
-    def getData(self, max_size=None):
+    def getValue(self, max_size=None):
         return None
 
     def getDisplayData(self):
-        return self.getData()
+        if self.display != None:
+            return self.display
+        else:
+            return self.getValue()
 
     def setParent(self, parent):
         self._parent = parent
@@ -47,17 +57,25 @@
     addr = property(_getAddr, _setAddr)        
     size = property(_getSize)        
     id = property(__getId, __setId)
+    value = property(getValue)
     
 class FilterChunk(Chunk):
     def __init__(self, id, filter, parent):
         Chunk.__init__(self, id, filter.getDescription(), filter.getStream(), filter.getAddr(), filter.getSize(), parent)
         self._filter = filter
         self._filter.filter_chunk = self
+    
+    def postProcess(self):        
+        self._filter.postProcess()
 
+    def getFormat(self):
+        return self._filter.getId()
+
     def update(self):
         new = self._filter.clone()
-        if new == None: return
-        self.setFilter(new)
+        if new != None:
+            self.setFilter(new)
+        Chunk.update(self)
 
     def setFilter(self, filter):
         self._filter = filter
@@ -75,34 +93,116 @@
     def getDisplayData(self):
         return &quot;(...)&quot; 
         
-    def getData(self, max_size=None):
+    def getValue(self, max_size=None):
         return self._filter
+    value = property(getValue)
 
     def getFilter(self):
         return self._filter
 
+class StringChunk(Chunk):
+    def __init__(self, id, description, stream, str_type, parent):
+        Chunk.__init__(self, id, description, stream, stream.tell(), 0, parent)
+        self._str_type = str_type
+        self._read()
+
+    def getFormat(self):
+        return &quot;c-string&quot;
+
+    def _read(self):
+#        if self._str_type == &quot;C&quot;: ...
+        self._stream.seek(self.addr)
+        self._size = self._stream.searchLength(&quot;\0&quot;, True)
+        assert self._size != -1
+        self.str = self._stream.getN(self._size-1)
+
+    def update(self):
+        Chunk.update(self)
+        self._read()
+
+    def getValue(self, max_size=None):
+        return self.str
+    value = property(getValue)
+
+    def getDisplayData(self):
+        return convertDataToPrintableString(self.str)
+        
+class FormatChunkCache:
+    def __init__(self, chunk):
+        self._value = {}
+        self._addr = None
+        self._format = None
+        self._size = None
+        self._chunk = chunk
+        
+    def _isArray(self, format):
+        if self._chunk.isString(): return False
+        endian, size, type = splitFormat(format)
+        return (size != &quot;1&quot; and size != &quot;&quot;)
+
+    def _getRawData(self, max_size=None):
+        stream = self._chunk.getStream()
+        stream.seek(self._addr)
+        if (max_size == None or self._size&lt;max_size) or not self._chunk.isString():
+            data = stream.getN(self._size)
+            return data, False
+        else:
+            data = stream.getN(max_size)
+            return data+&quot;(...)&quot;, True
+
+    def update(self):
+        real_format = self._chunk.getRealFormat(self._chunk.getFormat())
+        if self._addr != self._chunk.addr or self._format != real_format:
+            # Invalidate the cache
+            self._value = {}
+            self._format = real_format
+            self._addr = self._chunk.addr
+            self._size = struct.calcsize(self._format)
+
+    def getSize(self):
+        self.update()
+        return self._size
+
+    def getValue(self, max_size=None):
+        self.update()
+        if max_size not in self._value:
+            data, truncated = self._getRawData(max_size)
+            if not truncated:
+                data = struct.unpack(self._format, data)
+                if not self._isArray(self._format):
+                    data = data[0]
+            self._value[max_size] = data               
+        return self._value[max_size]
+
 class FormatChunk(Chunk):
     def __init__(self, id, description, stream, addr, format, parent):
         Chunk.__init__(self, id, description, stream, addr, 0, parent)
-        self.__stream = stream
-        self.__addr = addr
+        if not checkFormat(format):
+            raise Exception(&quot;Invalid FormatChunk format: \&quot;%s\&quot;!&quot; % format)
         self.__format = format
-        self.value = None
+        self._cache = FormatChunkCache(self)
 
-    def update(self):
-        # Don't need to do anything
-        pass
+    def getFormat(self):
+        return self.__format
 
     def _getSize(self):
-        return struct.calcsize(self.getRealFormat())
+        return self._cache.getSize()
     size = property(_getSize)        
 
-    def __replaceFormatSize(self, format):
+    def getRealFormat(self, format):
         return re.sub(r'\{([^}]+)\}', self.__replaceFieldFormat, format)
 
-    def getRealFormat(self):
-        return self.__replaceFormatSize(self.__format)
+    def isString(self):
+        return self.__format[-1] == &quot;s&quot;
 
+    def __replaceFieldFormat(self, match):
+        id = match.group(1)
+        if id == &quot;@end@&quot;:
+            size = self._stream.getLastPos() - self.addr + 1
+        else:
+            size = getattr(self._parent, id)
+        return str(size)
+
     def getFormat(self): return self.__format
     
     def convertToStringSize(self, size):
@@ -118,8 +218,8 @@
             raise Exception(&quot;Invalid FormatChunk format: \&quot;%s\&quot;!&quot; % format)
         
         # Check new size
-        size = struct.calcsize(self.__replaceFormatSize(format))
-        if self.__stream.getLastPos() &lt; self.addr + size:
+        size = struct.calcsize(self.getRealFormat(format))
+        if self._stream.getLastPos() &lt; self.addr + size:
             raise Exception(&quot;Can't set chunk %s to format \&quot;%s\&quot;: size too big!&quot; % (self.id, format))
 
         # Update format
@@ -144,65 +244,16 @@
             else:
                 self._parent.rescan(self, diff_size, new_id=old_id, new_description=old_description)
         self._parent.updateFormatChunk(self)
-
-    def isArray(self):
-        if self.isString(): return False
-        m = re.compile(&quot;^.?([0-9]+)[^0-9]+$&quot;).match(self.__format)
-        if m == None: return False
-        return m.group(1) != &quot;1&quot;
-        
-    def isString(self):
-        return self.__format[-1] == &quot;s&quot;
-
-    def getRawData(self, max_size=None):
-        &quot;&quot;&quot; max_size can be None &quot;&quot;&quot;
-        self.__stream.seek(self.addr)
-        if (max_size == None or self.size&lt;max_size) or not self.isString():
-            data = self.__stream.getN(self.size)
-            return data, False
-        else:
-            data = self.__stream.getN(max_size)
-            return data+&quot;(...)&quot;, True
-
-    def __replaceFieldFormat(self, match):
-#        return str(getattr(self, match.group(1)))
-        id = match.group(1)
-        if id == &quot;@end@&quot;:
-            size = self.__stream.getLastPos() - self.addr + 1
-        else:
-            size = getattr(self._parent, id)
-        return str(size)
    
-    def getData(self, max_size=None):
-        data, truncated = self.getRawData(max_size)
-        if not truncated:
-            format = self.getRealFormat()
-            data = struct.unpack(format, data)
-            if not self.isArray():
-                data = data[0]
-        return data
+    def getValue(self, max_size=None):
+        return self._cache.getValue(max_size)
+    value = property(getValue)
 
     def getDisplayData(self):
-#        if self.id == None: return &quot;-&quot;
-        data = self.getData(20)
+        if self.display != None:
+            return self.display
+        data = self.getValue(20)
         if type(data)==types.StringType:
-            if len(data) == 0:
-                return &quot;(empty)&quot;
-            display = &quot;&quot;
-            for c in data:
-                if ord(c)&lt;32:
-                    know = { \
-                        &quot;\n&quot;: &quot;\\n&quot;,
-                        &quot;\r&quot;: &quot;\\r&quot;,
-                        &quot;\t&quot;: &quot;\\t&quot;,
-                        &quot;\0&quot;: &quot;\\0&quot;}
-                    if c in know:
-                        display = display + know[c]
-                    else:
-                        display = display + &quot;\\x%02X&quot; % ord(c)
-                elif c in string.printable:
-                    display = display + c
-                else:
-                    display = display + &quot;.&quot;
-            return &quot;\&quot;%s\&quot;&quot; % display
-        return data 
+            return convertDataToPrintableString(data)
+        else:
+            return data 

Added: haypo/hachoir/export.template
===================================================================
--- haypo/hachoir/export.template	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/export.template	2005-11-02 03:21:07 UTC (rev 245)
@@ -0,0 +1,13 @@
+&quot;&quot;&quot;
+Exported filter.
+
+Description:
+{description}
+&quot;&quot;&quot;
+
+from filter import Filter
+
+class MyFilter(Filter):
+    def __init__(self, stream):
+        Filter.__init__(self, &quot;{id}&quot;, &quot;{description}&quot;, stream, None)
+{chunks}

Modified: haypo/hachoir/filter.py
===================================================================
--- haypo/hachoir/filter.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/filter.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -7,7 +7,7 @@
 import string
 import types
 import ui
-from chunk import Chunk, FormatChunk, FilterChunk
+from chunk import Chunk, FormatChunk, FilterChunk, StringChunk
 from format import splitFormat    
 from error import error
 from tools import getBacktrace
@@ -117,7 +117,7 @@
         else:
             prev_chunk = None
         
-        if False: #prev_chunk != None and 1&lt;len(self._chunks) and issubclass(prev_chunk.__class__, FormatChunk):
+        if prev_chunk != None and issubclass(prev_chunk.__class__, FormatChunk):
             # If last chunk is a FormatChunk, update it's size
             format = splitFormat(prev_chunk.getFormat())
             if self.getParent() == None:
@@ -215,11 +215,7 @@
         return chunk
 
     def displayChunk(self, chunk):
-        type = chunk.__class__
-        if issubclass(type, FormatChunk):
-            type = chunk.getFormat()
-        elif issubclass(type, FilterChunk):
-            type = chunk.getFilter().getId()
+        type = chunk.getFormat()
         ui.window.add_table(None, chunk.addr, chunk.size, type, chunk.id, chunk.description, chunk.getDisplayData())
 
     def redisplay(self):  
@@ -259,13 +255,13 @@
 
     def readLine(self, id, description, eol=&quot;\n&quot;, fails_if_not_found=False, can_truncate=False):
         lg = self.searchEol(eol)
-        self.read(id, &quot;!%us&quot; % lg, description, can_truncate)
+        self.read(id, &quot;!%us&quot; % lg, description, truncate=can_truncate)
         line = getattr(self, id)
         setattr(self, id, line[:-len(eol)])
 
     def updateFormatChunk(self, chunk):
         if chunk.id == None: return
-        data = chunk.getData()
+        data = chunk.getValue()
         setattr(self, chunk.id, data)       
 
     def _appendChunk(self, chunk, can_truncate=False, position=None):
@@ -292,14 +288,14 @@
             if hasattr(self, id):
                 raise Exception(&quot;Chunk identifier \&quot;%s\&quot; already exist!&quot; % id)
             if can_truncate:
-                data = chunk.getData(40)
+                data = chunk.getValue(40)
             else:
-                data = chunk.getData()
+                data = chunk.getValue()
             setattr(self, id, data)
             self._chunks_dict[id] = chunk
 
-    def readChild(self, id, filter_class, description): 
-        filter = filter_class(self._stream, self)
+    def readChild(self, id, filter_class, description, *args): 
+        filter = filter_class(self._stream, self, *args)
         self.addFilter(id, filter)
     
     def addFilter(self, id, filter): 
@@ -312,14 +308,25 @@
         filter = ArrayFilter(id, description, self._stream, self, entry_class, end_func)
         self.addFilter(id, filter)
     
-    def read(self, id, format, description, can_truncate=True):
+    def readString(self, id, format, description):
         &quot;&quot;&quot; Returns chunk &quot;&quot;&quot;
+        chunk = StringChunk(id, description, self._stream, format, self)
+        self._appendChunk(chunk)
+        self._stream.seek(chunk.addr + chunk.size)
+        return chunk
+    
+    def read(self, id, format, description, post=None, truncate=False):
+        &quot;&quot;&quot; Returns chunk &quot;&quot;&quot;
         chunk = FormatChunk(id, description, self._stream, self._stream.tell(), format, self)
-        self._stream.seek(chunk.size, 1)
-        self._appendChunk(chunk, can_truncate)
+        self._appendChunk(chunk, can_truncate=truncate)
         self._stream.seek(chunk.addr + chunk.size)
+        chunk.post_process = post
         return chunk
 
+    def postProcess(self):
+        for chunk in self._chunks:
+            chunk.postProcess()
+
     def __str__(self):
         return &quot;Filter(%s) &lt;id=%s, description=%s&gt;&quot; % \
             (self.__class__, self.getId(), self.getDescription())
@@ -328,6 +335,26 @@
         chunk.setFormat(&quot;!%ss&quot; % size, &quot;split&quot;, id, desc)
         self.convertChunkToFilter(chunk)
 
+    def convertFilterToChunk(self, chunk):
+        # Create new format chunk
+        filter = chunk.getFilter()
+        id = self.getUniqChunkId(filter.getId())
+        new_chunk = FormatChunk(id, filter.getDescription(), filter.getStream(), filter.getAddr(), &quot;!%us&quot; % filter.getSize(), self)
+
+        # Delete old chunk
+        if chunk.id in self._chunks_dict:
+            del self._chunks_dict[chunk.id]
+        if hasattr(self, chunk.id):
+            delattr(self, chunk.id)
+
+        # Assign new chunk
+        pos = self._chunks.index(chunk)
+        self._chunks[pos] = new_chunk
+        self._chunks_dict[id] = new_chunk
+        setattr(self, id, chunk.getValue(40))
+        self.redisplay()
+        return new_chunk 
+
     def convertChunkToFilter(self, chunk):
         # Create new filter
         stream = self.getStream()

Modified: haypo/hachoir/hachoir.glade
===================================================================
--- haypo/hachoir/hachoir.glade	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/hachoir.glade	2005-11-02 03:21:07 UTC (rev 245)
@@ -198,6 +198,22 @@
 		  &lt;property name=&quot;homogeneous&quot;&gt;True&lt;/property&gt;
 		&lt;/packing&gt;
 	      &lt;/child&gt;
+
+	      &lt;child&gt;
+		&lt;widget class=&quot;GtkToolButton&quot; id=&quot;toolbutton_export&quot;&gt;
+		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;tooltip&quot; translatable=&quot;yes&quot;&gt;Export current filter to python script&lt;/property&gt;
+		  &lt;property name=&quot;stock_id&quot;&gt;gtk-convert&lt;/property&gt;
+		  &lt;property name=&quot;visible_horizontal&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;visible_vertical&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;is_important&quot;&gt;False&lt;/property&gt;
+		  &lt;signal name=&quot;clicked&quot; handler=&quot;on_toolbutton_export&quot; last_modification_time=&quot;Wed, 02 Nov 2005 00:47:19 GMT&quot;/&gt;
+		&lt;/widget&gt;
+		&lt;packing&gt;
+		  &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;homogeneous&quot;&gt;True&lt;/property&gt;
+		&lt;/packing&gt;
+	      &lt;/child&gt;
 	    &lt;/widget&gt;
 	  &lt;/child&gt;
 	&lt;/widget&gt;
@@ -263,7 +279,7 @@
       &lt;signal name=&quot;activate&quot; handler=&quot;onNewChunk&quot; last_modification_time=&quot;Sun, 30 Oct 2005 23:08:19 GMT&quot;/&gt;
 
       &lt;child internal-child=&quot;image&quot;&gt;
-	&lt;widget class=&quot;GtkImage&quot; id=&quot;image32&quot;&gt;
+	&lt;widget class=&quot;GtkImage&quot; id=&quot;image40&quot;&gt;
 	  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 	  &lt;property name=&quot;stock&quot;&gt;gtk-cut&lt;/property&gt;
 	  &lt;property name=&quot;icon_size&quot;&gt;1&lt;/property&gt;
@@ -284,7 +300,7 @@
       &lt;signal name=&quot;activate&quot; handler=&quot;onNewFilter&quot; last_modification_time=&quot;Mon, 31 Oct 2005 06:42:27 GMT&quot;/&gt;
 
       &lt;child internal-child=&quot;image&quot;&gt;
-	&lt;widget class=&quot;GtkImage&quot; id=&quot;image33&quot;&gt;
+	&lt;widget class=&quot;GtkImage&quot; id=&quot;image41&quot;&gt;
 	  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 	  &lt;property name=&quot;stock&quot;&gt;gtk-cut&lt;/property&gt;
 	  &lt;property name=&quot;icon_size&quot;&gt;1&lt;/property&gt;
@@ -298,14 +314,14 @@
   &lt;/child&gt;
 
   &lt;child&gt;
-    &lt;widget class=&quot;GtkImageMenuItem&quot; id=&quot;convert_to_filter&quot;&gt;
+    &lt;widget class=&quot;GtkImageMenuItem&quot; id=&quot;convert&quot;&gt;
       &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-      &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;_Convert string chunk to filter&lt;/property&gt;
+      &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;_Convert chunk &lt;=&gt; filter&lt;/property&gt;
       &lt;property name=&quot;use_underline&quot;&gt;True&lt;/property&gt;
-      &lt;signal name=&quot;activate&quot; handler=&quot;onConvertToFilter&quot; last_modification_time=&quot;Tue, 01 Nov 2005 01:30:56 GMT&quot;/&gt;
+      &lt;signal name=&quot;activate&quot; handler=&quot;onConvert&quot; last_modification_time=&quot;Wed, 02 Nov 2005 02:32:16 GMT&quot;/&gt;
 
       &lt;child internal-child=&quot;image&quot;&gt;
-	&lt;widget class=&quot;GtkImage&quot; id=&quot;image34&quot;&gt;
+	&lt;widget class=&quot;GtkImage&quot; id=&quot;image42&quot;&gt;
 	  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 	  &lt;property name=&quot;stock&quot;&gt;gtk-convert&lt;/property&gt;
 	  &lt;property name=&quot;icon_size&quot;&gt;1&lt;/property&gt;
@@ -326,7 +342,7 @@
       &lt;signal name=&quot;activate&quot; handler=&quot;onSetFormat&quot; last_modification_time=&quot;Sun, 30 Oct 2005 23:27:49 GMT&quot;/&gt;
 
       &lt;child internal-child=&quot;image&quot;&gt;
-	&lt;widget class=&quot;GtkImage&quot; id=&quot;image35&quot;&gt;
+	&lt;widget class=&quot;GtkImage&quot; id=&quot;image43&quot;&gt;
 	  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 	  &lt;property name=&quot;stock&quot;&gt;gtk-edit&lt;/property&gt;
 	  &lt;property name=&quot;icon_size&quot;&gt;1&lt;/property&gt;
@@ -347,7 +363,7 @@
       &lt;signal name=&quot;activate&quot; handler=&quot;onDeleteChunk&quot; last_modification_time=&quot;Tue, 01 Nov 2005 01:54:40 GMT&quot;/&gt;
 
       &lt;child internal-child=&quot;image&quot;&gt;
-	&lt;widget class=&quot;GtkImage&quot; id=&quot;image36&quot;&gt;
+	&lt;widget class=&quot;GtkImage&quot; id=&quot;image44&quot;&gt;
 	  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 	  &lt;property name=&quot;stock&quot;&gt;gtk-delete&lt;/property&gt;
 	  &lt;property name=&quot;icon_size&quot;&gt;1&lt;/property&gt;

Modified: haypo/hachoir/hachoir.py
===================================================================
--- haypo/hachoir/hachoir.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/hachoir.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -19,11 +19,10 @@
     print &quot;Usage: %s [options] file&quot; % (sys.argv[0])
     print &quot;&quot;
     print &quot;Options:&quot;
-    print &quot;\t--help            : Show this help&quot;
+    print &quot;\t--script file.py  : Load python script&quot;
     print &quot;\t--version         : Show the program version&quot;
     print &quot;\t--verbose         : Activate verbose mode&quot;
-    print &quot;\t--depth NB        : Detail depth (default %u)&quot; % (defval[&quot;depth&quot;])
-    print &quot;\t--no-display      : Hide result&quot;
+    print &quot;\t--help            : Show this help&quot;
 
 def parseArgs(val):
     import getopt
@@ -31,7 +30,7 @@
     
     try:
         short = &quot;&quot;
-        long = [&quot;no-display&quot;, &quot;verbose&quot;, &quot;help&quot;, &quot;version&quot;, &quot;depth=&quot;]
+        long = [&quot;verbose&quot;, &quot;help&quot;, &quot;version&quot;, &quot;script=&quot;]
         opts, args = getopt.getopt(sys.argv[1:], short, long)
     except getopt.GetoptError:
         usage(def_val)
@@ -52,10 +51,8 @@
         if o == &quot;--version&quot;:
             print &quot;%s version %s&quot; % (PROGRAM, VERSION)
             sys.exit()
-        if o == &quot;--no-display&quot;:
-            val[&quot;display&quot;] = False
-        if o == &quot;--depth&quot;:
-            val[&quot;depth&quot;] = int(a)
+        if o == &quot;--script&quot;:
+            val[&quot;script&quot;] = a
         if o == &quot;--verbose&quot;:
             val[&quot;verbose&quot;] = True
     return (val, filename,)
@@ -76,9 +73,8 @@
         log.info(&quot;Loaded: %u plugings (%s)&quot; % (len(modules), &quot;, &quot;.join(modules)))
 
         opt = {
-            &quot;depth&quot;: 2,
             &quot;verbose&quot;: False,
-            &quot;display&quot;: True
+            &quot;script&quot;: None
         }
         opt, filename = parseArgs(opt)
 

Modified: haypo/hachoir/hachoir_class.py
===================================================================
--- haypo/hachoir/hachoir_class.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/hachoir_class.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -6,12 +6,16 @@
 from error import error
 
 class Hachoir:
+    instance = None
+    
     def __init__(self):
+        Hachoir.instance = self
         self.verbose = False
         self.display = True
         self.depth = 5
         self.ui = None 
         self.main_filter = None
+        self.script = None
 
     def onGoParent(self):
         if self.filter.getParent() == None: return
@@ -39,7 +43,6 @@
             chunk = old_filter.filter_chunk
             chunk.setFilter(self.filter)
             diff_size = self.filter.getSize() - old_size
-            print &quot;Diff size = %s&quot; % diff_size
             chunk.getParent().rescan(chunk, diff_size)
         self.filter.display()
         self.ui.window.updateToolbar()
@@ -47,6 +50,10 @@
     def saveUser(self, filename):
         my = UserFilterDescriptor(filter=self.filter)
         my.writeIntoXML(filename)
+    
+    def exportUser(self, filename):
+        my = UserFilterDescriptor(filter=self.filter)
+        my.exportPython(filename)
         
     def load(self, filename):
         try:
@@ -65,6 +72,16 @@
         # Split 
         try:
             filter = split_func(stream)
+            filter.postProcess()
+            size = filter.getSize()
+            diff_size = (size - stream.getSize())
+            if diff_size &lt; 0:
+                chunks = filter.getChunks()
+                if len(chunks) != 0:
+                    last_chunk = chunks[-1]
+                else:
+                    last_chunk = None
+                filter.addRawChunk(last_chunk, &quot;end&quot;, &quot;{@end@}&quot;, &quot;&quot;)
         except Exception, msg:
             error(&quot;Exception while processing file %s with filter %s:\n%s&quot; \
                 % (filename, plugin_name, msg))
@@ -74,11 +91,23 @@
         self.filter.display()
 
         # Display
-        if self.display:
+        if self.display and display_func != None:
             display_func(self.filter)
         self.ui.window.updateToolbar()
 
+    def loadScript(self, filename):
+        try:
+            f = open(self.script, 'r')
+            script = f.read()
+            f.close()
+            compiled = compile(script, self.script, 'exec')
+            exec compiled
+        except Exception, msg:
+            error(&quot;Exception while loading script \&quot;%s\&quot;:\n%s&quot; % (filename, msg))
+
     def run(self, filename):
-        if filename != None:
+        if self.script:
+            self.loadScript(self.script)
+        elif filename != None:
             self.load(filename)
         self.ui.run()      

Modified: haypo/hachoir/plugins/gif.py
===================================================================
--- haypo/hachoir/plugins/gif.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/plugins/gif.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -1,7 +1,7 @@
 &quot;&quot;&quot;
 GIF splitter.
 
-Status: only loads header, and is buggy ...
+Status: loads header, don't load image data (stop filter), and is buggy ...
 Author: Victor Stinner
 &quot;&quot;&quot;
 
@@ -60,13 +60,13 @@
             assert issubclass(parent.__class__, GifFile)
             screen = parent.getChunk(&quot;screen&quot;).getFilter()
             self._nb_colors = (1 &lt;&lt; screen.bits_per_pixel)
-        self.readArray(&quot;map&quot;, GifColor, &quot;Color map&quot;, self.checkEndOfMap)
+        self.readArray(&quot;color&quot;, GifColor, &quot;Color map&quot;, self.checkEndOfMap)
 
     def checkEndOfMap(self, stream, array, color):
         return len(array) == self._nb_colors 
 
     def __str__(self):
-        return &quot;Gif colormap &lt;colors=%u&gt;&quot; % (len(self.map))
+        return &quot;Gif colormap &lt;colors=%u&gt;&quot; % (len(self.color))
         
 class GifExtensionChunk(Filter):
     def __init__(self, stream, parent):
@@ -91,14 +91,22 @@
         self.read(&quot;height&quot;, &quot;&lt;H&quot;, &quot;Height&quot;)
 
         # TODO: Fix this
-        self.read(&quot;flags&quot;, &quot;&lt;B&quot;, &quot;Flags&quot;)
-        self.global_map = ((self.flags &amp; 0x80) == 0x80) # ok
-        self.color_res = 1 + ((self.flags &gt;&gt; 4) &amp; 0x7) # ??
-        self.bits_per_pixel = 1 + (self.flags &amp; 0x7) # ok
+        self.read(&quot;flags&quot;, &quot;&lt;B&quot;, &quot;Flags&quot;, post=processFlags)
         # -- End of TODO
         
         self.read(&quot;background&quot;, &quot;&lt;B&quot;, &quot;Background color&quot;)
         self.read(&quot;notused&quot;, &quot;&lt;B&quot;, &quot;Not used (zero)&quot;)
+
+    def processFlags(self, chunk):
+        flags = chunk.value
+        self.global_map = ((flags &amp; 0x80) == 0x80) # ok
+        self.color_res = 1 + ((flags &gt;&gt; 4) &amp; 0x7) # ??
+        self.bits_per_pixel = 1 + (flags &amp; 0x7) # ok
+        if self.global_map:
+            text = &quot;global map, &quot;
+        else:
+            text = &quot;&quot;
+        return text + &quot;color res=%u, bits/pixel=%u&quot; % (self.color_res, self.bits_per_pixel)
         
 class GifFile(Filter):
     def __init__(self, stream):
@@ -116,7 +124,7 @@
         self.images = []
         while True:
             code = self.read(&quot;separator[]&quot;, &quot;c&quot;, &quot;Separator code&quot;)
-            code = code.getData()
+            code = code.getValue()
             if code == &quot;!&quot;:
                 self.readChild(&quot;extensions[]&quot;, GifExtension, &quot;Extension&quot;)
             elif code == &quot;,&quot;:

Added: haypo/hachoir/plugins/gzip.py
===================================================================
--- haypo/hachoir/plugins/gzip.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/plugins/gzip.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -0,0 +1,77 @@
+&quot;&quot;&quot;
+Exported filter.
+
+Description:
+GZIP archive file
+&quot;&quot;&quot;
+
+import datetime
+from filter import Filter
+from plugin import registerPlugin
+
+class GzipFile(Filter):
+    def __init__(self, stream):
+        Filter.__init__(self, &quot;gzip_file&quot;, &quot;GZIP archive file&quot;, stream, None)
+        self.read(&quot;id&quot;, &quot;!2B&quot;, &quot;Identifier (31,139)&quot;)
+        assert self.id == (31, 139)
+        self.read(&quot;comp_method&quot;, &quot;!B&quot;, &quot;Compression method&quot;, post=self.getCompressionMethod)
+        self.read(&quot;flags&quot;, &quot;!B&quot;, &quot;Flags&quot;, post=self.getFlags)
+        self.read(&quot;mtime&quot;, &quot;&lt;1L&quot;, &quot;Modification time&quot;, post=self.getMTime)
+        self.read(&quot;extra&quot;, &quot;!B&quot;, &quot;Extra flags&quot;)
+        self.read(&quot;os&quot;, &quot;!B&quot;, &quot;OS&quot;, post=self.getOS)
+
+        if self.extra &amp; 4 == 4:
+            self.read(&quot;extra_length&quot;, &quot;&lt;2H&quot;, &quot;Extra length&quot;)
+            self.read(&quot;extra&quot;, &quot;!{extra_length}s&quot;, &quot;Extra&quot;)
+        if self.flags &amp; 8 == 8:
+            self.readString(&quot;filename&quot;, &quot;C&quot;, &quot;Filename&quot;)
+        if self.flags &amp; 16 == 16:
+            self.readString(&quot;comment&quot;, &quot;C&quot;, &quot;Comment&quot;)
+        if self.flags &amp; 2 == 2:
+            self.readString(&quot;crc16&quot;, &quot;!H&quot;, &quot;CRC16&quot;)
+
+        size = stream.getSize() - stream.tell() - 8
+        self.read(&quot;data&quot;, &quot;!%us&quot; % size, &quot;Compressed data&quot;, truncate=True)
+        self.read(&quot;crc32&quot;, &quot;&lt;L&quot;, &quot;CRC32&quot;)
+        self.read(&quot;size&quot;, &quot;&lt;L&quot;, &quot;Uncompressed size&quot;)
+
+    def getFlags(self, chunk):
+        val = chunk.value
+        flags = []
+        if val &amp; 1 == 1: flags.append(&quot;text&quot;)
+        if val &amp; 2 == 2: flags.append(&quot;crc16&quot;)
+        if val &amp; 4 == 4: flags.append(&quot;extra&quot;)
+        if val &amp; 8 == 8: flags.append(&quot;filename&quot;)
+        if val &amp; 16 == 16: flags.append(&quot;comment&quot;)
+        return &quot;|&quot;.join(flags)
+        
+    def getCompressionMethod(self, chunk):
+        val = chunk.value
+        if val &lt; 8: return &quot;reserved&quot;
+        if val == 8: return &quot;deflate&quot;
+        return &quot;Unknow (%s)&quot; % val
+
+    def getMTime(self, chunk):
+        dt = datetime.datetime.fromtimestamp(chunk.value)
+        return str(dt)
+
+    def getOS(self, chunk):
+        os = { \
+            0: &quot;FAT filesystem&quot;,
+            1: &quot;Amiga&quot;,
+            2: &quot;VMS (or OpenVMS)&quot;,
+            3: &quot;Unix&quot;,
+            4: &quot;VM/CMS&quot;,
+            5: &quot;Atari TOS&quot;,
+            6: &quot;HPFS filesystem (OS/2, NT)&quot;,
+            7: &quot;Macintosh&quot;,
+            8: &quot;Z-System&quot;,
+            9: &quot;CP/M&quot;,
+            10: &quot;TOPS-20&quot;,
+            11: &quot;NTFS filesystem (NT)&quot;,
+            12: &quot;QDOS&quot;,
+            13: &quot;Acorn RISCOS&quot;}            
+        val = chunk.value
+        return os.get(val, &quot;Unknow (%s)&quot; % val)
+        
+registerPlugin(&quot;^.*\.gz$&quot;, &quot;GZIP archive file&quot;, GzipFile, None)

Modified: haypo/hachoir/plugins/png.py
===================================================================
--- haypo/hachoir/plugins/png.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/plugins/png.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -51,26 +51,19 @@
 class PngGamma(Filter):
     def __init__(self, stream, parent):
         Filter.__init__(self, &quot;png_gamma&quot;, &quot;PNG gamma&quot;, stream, parent)
-        self.read(&quot;gamma&quot;, &quot;!L&quot;, &quot;Gamma (x10,000)&quot;)
-        self.gamma = float(self.gamma)
-        self.gamma = self.gamma / 10000
+        self.read(&quot;gamma&quot;, &quot;!L&quot;, &quot;Gamma (x10,000)&quot;, post=self.getGamma)
 
+    def getGamma(self, chunk):
+        return float(chunk.value) / 10000
+
     def __str__(self):
         return &quot;PNG gamma &lt;gamma=%0.2f&gt;&quot; % (self.gamma)
 
 class PngText(Filter):
     def __init__(self, stream, parent):
         Filter.__init__(self, &quot;png_text&quot;, &quot;PNG text&quot;, stream, parent)
-        max_length = parent.size
-        print &quot;max&quot;,max_length
-        old = self._stream.tell()
-        pos = self._stream.search(&quot;\0&quot;, max_length)
-        if pos == -1:
-            raise Exception(&quot;Fails to find end of text&quot;)
-        lg = (pos-old)
-        self.read(&quot;keyword&quot;, &quot;!%us&quot; % lg, &quot;Keyword&quot;)
-        self.read(&quot;separator&quot;, &quot;!B&quot;, &quot;Null byte used to separe strings&quot;)
-        lg = (self._parent.size-lg-1)
+        chunk = self.readString(&quot;keyword&quot;, &quot;C&quot;, &quot;Keyword&quot;)
+        lg = self._parent.size - chunk.size
         self.read(&quot;text&quot;, &quot;!%us&quot; % lg, &quot;Text&quot;)
 
     def __str__(self):

Modified: haypo/hachoir/plugins/tar.py
===================================================================
--- haypo/hachoir/plugins/tar.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/plugins/tar.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -9,6 +9,7 @@
 from datetime import datetime
 from filter import Filter
 from plugin import registerPlugin
+from tools import convertDataToPrintableString
 
 def displayModeItem(mode):
     if mode &amp; 4 == 4: r=&quot;r&quot;
@@ -42,38 +43,60 @@
         displayFile(file)
 
 class TarFileEntry(Filter):
+    def stripNul(self, chunk):
+        return chunk.value.strip(&quot;\0&quot;)
+
+    def getMode(self, chunk):
+        mode = self.octal2int(chunk.value)
+        owner = self._getModeItem(mode &gt;&gt; 6 &amp; 7)
+        group = self._getModeItem(mode &gt;&gt; 3 &amp; 7)
+        other = self._getModeItem(mode &amp; 7)
+        return &quot;%04o (%s%s%s)&quot; % (mode, owner, group, other)
+
+    def _getModeItem(mode):
+        if mode &amp; 4 == 4: r=&quot;r&quot;
+        else: r=&quot;-&quot;
+        if mode &amp; 2 == 2: w=&quot;w&quot;
+        else: w=&quot;-&quot;
+        if mode &amp; 1 == 1: x=&quot;x&quot;
+        else: x=&quot;-&quot;
+        return &quot;%c%c%c&quot; % (r, w, x) 
+
+    def convertOctal(self, chunk):
+        return self.octal2int(chunk.value)
+
+    def stripNul(self, chunk):
+        val = chunk.value.strip(&quot;\0&quot;)
+        return convertDataToPrintableString(val)
+
+    def getTime(self, chunk):
+        value = self.octal2int(chunk.value) 
+        return datetime.fromtimestamp(value)
+
     def __init__(self, stream, parent):
         Filter.__init__(self, &quot;tar_file_entry&quot;,&quot;Tar file entry&quot;, stream, parent)
-        self.read(&quot;name&quot;, &quot;!100s&quot;, &quot;Name&quot;, False)
+        self.read(&quot;name&quot;, &quot;!100s&quot;, &quot;Name&quot;, truncate=False, post=self.stripNul)
         self.name = self.name.strip(&quot;\0&quot;)
-        self.read(&quot;mode&quot;, &quot;!8s&quot;, &quot;Mode&quot;)
-        self.mode = self.octal2int(self.mode)
-        self.read(&quot;uid&quot;, &quot;!8s&quot;, &quot;User ID&quot;)
-        self.uid = self.octal2int(self.uid)
-        self.read(&quot;gid&quot;, &quot;!8s&quot;, &quot;Group ID&quot;)
-        self.gid = self.octal2int(self.gid)
-        self.read(&quot;size&quot;, &quot;!12s&quot;, &quot;Size&quot;)
+        self.read(&quot;mode&quot;, &quot;!8s&quot;, &quot;Mode&quot;, post=self.convertOctal)
+        self.read(&quot;uid&quot;, &quot;!8s&quot;, &quot;User ID&quot;, post=self.convertOctal)
+        self.read(&quot;gid&quot;, &quot;!8s&quot;, &quot;Group ID&quot;, post=self.convertOctal)
+        self.read(&quot;size&quot;, &quot;!12s&quot;, &quot;Size&quot;, post=self.convertOctal)
         self.size = self.octal2int(self.size)
-        self.read(&quot;mtime&quot;, &quot;!12s&quot;, &quot;Modification time&quot;)
-        self.mtime = self.octal2int(self.mtime) 
-        self.mtime = datetime.fromtimestamp(self.mtime)
+        self.read(&quot;mtime&quot;, &quot;!12s&quot;, &quot;Modification time&quot;, self.getTime)
         self.read(&quot;check_sum&quot;, &quot;!8s&quot;, &quot;Check sum&quot;)
         self.read(&quot;type&quot;, &quot;!c&quot;, &quot;Type&quot;)
-        self.read(&quot;lname&quot;, &quot;!100s&quot;, &quot;Link name&quot;, False)
-        self.read(&quot;magic&quot;, &quot;!8s&quot;, &quot;Magic&quot;)
-        self.magic = self.magic.strip(&quot; \0&quot;)
-        self.read(&quot;uname&quot;, &quot;!32s&quot;, &quot;User name&quot;)
-        self.uname = self.uname.strip(&quot;\0&quot;)
-        self.read(&quot;gname&quot;, &quot;!32s&quot;, &quot;Group name&quot;)
-        self.gname = self.gname.strip(&quot;\0&quot;)
+        self.read(&quot;lname&quot;, &quot;!100s&quot;, &quot;Link name&quot;, post=self.stripNul, truncate=False)
+        self.read(&quot;magic&quot;, &quot;!8s&quot;, &quot;Magic&quot;, post=self.stripNul)
+        self.read(&quot;uname&quot;, &quot;!32s&quot;, &quot;User name&quot;, post=self.stripNul)
+        self.read(&quot;gname&quot;, &quot;!32s&quot;, &quot;Group name&quot;, post=self.stripNul)
         self.read(&quot;devmajor&quot;, &quot;!8s&quot;, &quot;Dev major&quot;)
         self.read(&quot;devminor&quot;, &quot;!8s&quot;, &quot;Dev minor&quot;)
         self.read(&quot;header_padding&quot;, &quot;!167s&quot;, &quot;Padding (zero)&quot;)
         if self.type in (&quot;\0&quot;, &quot;0&quot;):
-            self.read(&quot;filedata&quot;, &quot;!{size}s&quot;, &quot;File data&quot;, True)
+            self.read(&quot;filedata&quot;, &quot;!{size}s&quot;, &quot;File data&quot;, truncate=True)
         if stream.tell() % 512 != 0:
             padding = 512 - stream.tell() % 512
-            self.read(&quot;padding&quot;, &quot;!%ss&quot; % padding, &quot;Padding (512 align)&quot;)
+            self.read(&quot;padding&quot;, &quot;!%ss&quot; % padding, &quot;Padding (512 align)&quot;, truncate=True)
 
     def isEmpty(self):
         return self.name == &quot;&quot;
@@ -115,14 +138,13 @@
 
         self.readArray(&quot;files&quot;, TarFileEntry, &quot;Tar Files&quot;, self.checkEndOfChunks)
         
-        padding = 4096 - stream.tell() % 4096
-        self.read(&quot;padding&quot;, &quot;!%ss&quot; % padding, &quot;Padding (4096 align)&quot;)
+#        padding = 4096 - stream.tell() % 4096
+#        self.read(&quot;padding&quot;, &quot;!%ss&quot; % padding, &quot;Padding (4096 align)&quot;)
+#        assert stream.eof()
 
-        assert stream.eof()
-
     def checkEndOfChunks(self, stream, array, file):
         if file != None:
             if file.isEmpty(): return True
         return stream.eof()
         
-registerPlugin(&quot;^.*\.tar$&quot;, &quot;Tar archive&quot;, TarFile, displayTar)
+registerPlugin(&quot;^.*\.tar$&quot;, &quot;Tar archive&quot;, TarFile, None)

Modified: haypo/hachoir/plugins/zip.py
===================================================================
--- haypo/hachoir/plugins/zip.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/plugins/zip.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -99,7 +99,7 @@
         self.files = []
         while not stream.eof():
             header = self.read(&quot;header[]&quot;, &quot;&lt;L&quot;, &quot;Header&quot;)
-            header = header.getData()
+            header = header.getValue()
             if header == 0x04034B50:
                 self.readChild(&quot;files[]&quot;, ZipFileEntry, &quot;File entry&quot;)
             elif header == 0x02014b50:

Modified: haypo/hachoir/tools.py
===================================================================
--- haypo/hachoir/tools.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/tools.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -1,5 +1,27 @@
 import traceback, sys
+import string
 
+def convertDataToPrintableString(data):
+    if len(data) == 0:
+        return &quot;(empty)&quot;
+    display = &quot;&quot;
+    for c in data:
+        if ord(c)&lt;32:
+            know = { \
+                &quot;\n&quot;: &quot;\\n&quot;,
+                &quot;\r&quot;: &quot;\\r&quot;,
+                &quot;\t&quot;: &quot;\\t&quot;,
+                &quot;\0&quot;: &quot;\\0&quot;}
+            if c in know:
+                display = display + know[c]
+            else:
+                display = display + &quot;\\x%02X&quot; % ord(c)
+        elif c in string.printable:
+            display = display + c
+        else:
+            display = display + &quot;.&quot;
+    return &quot;\&quot;%s\&quot;&quot; % display
+
 def getBacktrace():
     bt = traceback.format_exception( \
         sys.exc_type, sys.exc_value, sys.exc_traceback)

Modified: haypo/hachoir/ui_popup.py
===================================================================
--- haypo/hachoir/ui_popup.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/ui_popup.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -2,7 +2,7 @@
 pygtk.require ('2.0')
 import gtk
 import gtk.glade
-from chunk import FormatChunk
+from chunk import FormatChunk, FilterChunk
 from ui_new_chunk import NewChunkDialog
 from format import splitFormat # TODO: remove this line
 from error import error
@@ -19,7 +19,7 @@
         # Popup items
         self.new_chunk = xml.get_widget(&quot;new_chunk&quot;)
         self.new_filter = xml.get_widget(&quot;new_filter&quot;)
-        self.convert_to_filter = xml.get_widget(&quot;convert_to_filter&quot;)
+        self.convert = xml.get_widget(&quot;convert&quot;)
         self.set_format = xml.get_widget(&quot;set_format&quot;)
         self.delete_chunk = xml.get_widget(&quot;delete_chunk&quot;)
 
@@ -31,15 +31,19 @@
             return
 
         is_format_chunk = issubclass(self.chunk.__class__, FormatChunk)
+        is_filter_chunk = issubclass(self.chunk.__class__, FilterChunk)
         self.new_chunk.set_sensitive(is_format_chunk)
         self.new_filter.set_sensitive(is_format_chunk)
-        self.convert_to_filter.set_sensitive(is_format_chunk)
+        self.convert.set_sensitive(is_format_chunk or is_filter_chunk)
         self.set_format.set_sensitive(is_format_chunk)
 
-        can_delete = (self.chunk.getParent().getParent() != None)
-        if not can_delete:
-            chunks = self.chunk.getParent().getChunks()
-            can_delete = (chunks.index(self.chunk) &lt; len(chunks)-1) or not is_format_chunk
+#        can_delete = ()
+#        if not can_delete:
+        chunks = self.chunk.getParent().getChunks()
+        if self.chunk.getParent().getParent() != None:
+            can_delete = (1 &lt; len(chunks)) or not is_format_chunk
+        else:
+            can_delete = chunks.index(self.chunk) &lt; (len(chunks)-1) or not is_format_chunk
 
         self.delete_chunk.set_sensitive(can_delete)
         self.popup.popup( None, None, None, event.button, event.time)
@@ -47,9 +51,13 @@
     def onDeleteChunk(self, event):
         self.chunk.getParent().deleteChunk(self.chunk)
 
-    def onConvertToFilter(self, event):
-        assert issubclass(self.chunk.__class__, FormatChunk)
-        self.chunk.getParent().convertChunkToFilter(self.chunk)
+    def onConvert(self, event):
+        if issubclass(self.chunk.__class__, FormatChunk):
+            self.chunk.getParent().convertChunkToFilter(self.chunk)
+        elif issubclass(self.chunk.__class__, FilterChunk):
+            self.chunk.getParent().convertFilterToChunk(self.chunk)
+        else:
+            error(&quot;Can't convert chunk %s&quot; % self.chunk.id)
         
     def onNewChunk(self, event):
         if self.new_chunk_dlg.runNewChunk() == gtk.RESPONSE_CANCEL: return
@@ -79,7 +87,7 @@
         try:
             self.chunk.setFormat(format, &quot;rescan&quot;)
         except Exception, msg:
-            error(&quot;Exception while trying to set chunk %s format to \&quot;%s\&quot;.&quot; \
-                % (self.chunk.id, format))
+            error(&quot;Exception while trying to set chunk %s format to \&quot;%s\&quot;: %s&quot; \
+                % (self.chunk.id, format, msg))
             pass
         self.chunk.getParent().redisplay()

Modified: haypo/hachoir/ui_window.py
===================================================================
--- haypo/hachoir/ui_window.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/ui_window.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -134,6 +134,16 @@
             self.ui.hachoir.loadUser(filename)
         chooser.destroy()
 
+    def on_toolbutton_export(self, widget):
+        chooser = gtk.FileChooserDialog( \
+            title=&quot;Export current filter to python script ...&quot;,
+            action=gtk.FILE_CHOOSER_ACTION_SAVE,
+            buttons=(gtk.STOCK_CANCEL,gtk.RESPONSE_CANCEL,gtk.STOCK_SAVE,gtk.RESPONSE_OK))
+        if chooser.run() == gtk.RESPONSE_OK:
+            filename = chooser.get_filename() 
+            self.ui.hachoir.exportUser(filename)
+        chooser.destroy()
+
     def on_toolbutton_save(self, widget):
         chooser = gtk.FileChooserDialog( \
             title=&quot;Save filter into ...&quot;,

Modified: haypo/hachoir/user_filter.py
===================================================================
--- haypo/hachoir/user_filter.py	2005-11-01 23:30:00 UTC (rev 244)
+++ haypo/hachoir/user_filter.py	2005-11-02 03:21:07 UTC (rev 245)
@@ -45,6 +45,11 @@
             self.id = None 
             self.description = None 
             
+    def exportPython(self, filename):
+        file = open(filename, &quot;w&quot;)
+        file.write(self.toPython())
+        file.close()
+            
     def writeIntoXML(self, filename):
         file = open(filename, &quot;w&quot;)
         PrettyPrint(self.toXML(), file)
@@ -74,6 +79,20 @@
                     user_chunk = UserChunk(id, format, description)
                 self.chunks.append(user_chunk)
 
+    def toPython(self):
+        f = open('export.template', 'r')
+        tpl = f.read()
+        f.close()
+
+        chunks = &quot;&quot;
+        for chunk in self.chunks:
+            if chunks != &quot;&quot;: chunks = chunks + &quot;\n&quot;
+            chunks = chunks \
+                + &quot; &quot; * 8 \
+                + &quot;self.read(\&quot;%s\&quot;, \&quot;%s\&quot;, \&quot;%s\&quot;)&quot; \
+                  % (chunk.id, chunk.format, chunk.description)
+        return tpl.replace(&quot;{id}&quot;, self.id).replace(&quot;{description}&quot;, self.description).replace(&quot;{chunks}&quot;, chunks)
+
     def toXML(self):
         impl = getDOMImplementation()
         doc = impl.createDocument(None, &quot;user_filter&quot;, None)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000151.html">[Happyboom-svn] r244 - in haypo/hachoir: . plugins
</A></li>
	<LI>Next message: <A HREF="000153.html">[Happyboom-svn] r246 - in haypo/hachoir: . plugins
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#152">[ date ]</a>
              <a href="thread.html#152">[ thread ]</a>
              <a href="subject.html#152">[ subject ]</a>
              <a href="author.html#152">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/happyboom-svn">More information about the Happyboom-svn
mailing list</a><br>
</body></html>
