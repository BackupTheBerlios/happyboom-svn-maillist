<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Happyboom-svn] r183 - in boomboom: . client client/items server server/agents
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/happyboom-svn/2005-September/index.html" >
   <LINK REL="made" HREF="mailto:happyboom-svn%40lists.berlios.de?Subject=Re%3A%20%5BHappyboom-svn%5D%20r183%20-%20in%20boomboom%3A%20.%20client%20client/items%20server%20server/agents&In-Reply-To=%3C200509160443.j8G4h5Nt017074%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000089.html">
   <LINK REL="Next"  HREF="000091.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Happyboom-svn] r183 - in boomboom: . client client/items server server/agents</H1>
    <B>Victor STINNER at BerliOS</B> 
    <A HREF="mailto:happyboom-svn%40lists.berlios.de?Subject=Re%3A%20%5BHappyboom-svn%5D%20r183%20-%20in%20boomboom%3A%20.%20client%20client/items%20server%20server/agents&In-Reply-To=%3C200509160443.j8G4h5Nt017074%40sheep.berlios.de%3E"
       TITLE="[Happyboom-svn] r183 - in boomboom: . client client/items server server/agents">haypo at berlios.de
       </A><BR>
    <I>Fri Sep 16 06:43:05 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000089.html">[Happyboom-svn] r182 - in happyboom/trunk: client common server
</A></li>
        <LI>Next message: <A HREF="000091.html">[Happyboom-svn] r184 - boomboom boomboom/client boomboom/client/items boomboom/server boomboom/server/agents happyboom/trunk/client happyboom/trunk/common happyboom/trunk/server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#90">[ date ]</a>
              <a href="thread.html#90">[ thread ]</a>
              <a href="subject.html#90">[ subject ]</a>
              <a href="author.html#90">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: haypo
Date: 2005-09-16 06:42:34 +0200 (Fri, 16 Sep 2005)
New Revision: 183

Added:
   boomboom/server/agents/log.py
Modified:
   boomboom/boomboom_client.py
   boomboom/client/bb_constructor.py
   boomboom/client/bb_display.py
   boomboom/client/bb_input.py
   boomboom/client/items/character.py
   boomboom/client/items/projectile.py
   boomboom/client/items/weapon.py
   boomboom/client/items/world.py
   boomboom/protocol.xml
   boomboom/server/agents/__init__.py
   boomboom/server/agents/character.py
   boomboom/server/agents/game.py
   boomboom/server/agents/projectile.py
   boomboom/server/agents/weapon.py
   boomboom/server/agents/world.py
   boomboom/server/bb_server.py
Log:
Corrections de bugs et modifications pour la nouvelle architecture.


Modified: boomboom/boomboom_client.py
===================================================================
--- boomboom/boomboom_client.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/boomboom_client.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -1,4 +1,4 @@
-#!/usr/bin/python
+#!/usr/bin/python -W all
 # -*- coding: ISO-8859-1 -*-
 VERSION=&quot;0.2.0&quot;
 PROGRAM=&quot;BoomBoom client&quot;
@@ -63,8 +63,8 @@
     from client import BoomBoomClient
     from client.bb_display import BoomBoomDisplay
 
-    protocol = loadProtocol(&quot;protocol.xml&quot;)
-    display = BoomBoomDisplay(protocol, arg)
+    arg[&quot;protocol&quot;] = loadProtocol(&quot;protocol.xml&quot;)
+    display = BoomBoomDisplay(arg)
     client = BoomBoomClient(display, arg)
     try:
         client.start()

Modified: boomboom/client/bb_constructor.py
===================================================================
--- boomboom/client/bb_constructor.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/client/bb_constructor.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -5,6 +5,7 @@
 @version: 0.2
 &quot;&quot;&quot;
 from happyboom.common.event import EventListener
+from happyboom.common.log import log
 import bb_events
 from items import Sun, Projectile, Weapon, World, Character
 
@@ -13,44 +14,24 @@
     def __init__(self):
         &quot;&quot;&quot; BoomBoomConstructor constructor. &quot;&quot;&quot;
         EventListener.__init__(self, prefix=&quot;evt_&quot;)
+        self.registerEvent(&quot;happyboom&quot;)
         self.registerEvent(&quot;game&quot;)
-        self.registerEvent(bb_events.create)
-        self.registerEvent(bb_events.text)
+        self.registerEvent(&quot;log&quot;)
         
-    def evt_agent_manager_Create(self, event):
+    def evt_happyboom_doCreateItem(self, type, id):
         &quot;&quot;&quot; Create event handler.
         @param event: Event with &quot;agent_manager_Create&quot; type.
         @type event: C{L{common.event.Event}}
         &quot;&quot;&quot;
-        arg = event.content.split(&quot;:&quot;)
-        type = arg[0]
-        id = int(arg[1])
-        item = self.tryCreateItem(id, type)
-        if item != None:
-            event.source.send(&quot;yes&quot;)
-            event.source.send(type)
-            event.source.send(&quot;.&quot;)
-        else:
-            event.source.send(&quot;no&quot;)
-        
-    def tryCreateItem(self, id, type):
-        &quot;&quot;&quot; Constructs an item of required type.
-        @param id: Server id of the item.
-        @type id: C{int}
-        @param type: Type of item to construct.
-        @type type: C{str}
-        @return: The constructed item or C{None}, if the type does not exist.
-        @rtype: C{L{BoomBoomItem}}
-        &quot;&quot;&quot;
+        log.info(&quot;Try to create object %s ...&quot; % type)
         if type==&quot;projectile&quot;:
-            return Projectile()
+            Projectile()
         if type==&quot;weapon&quot;:
-            return Weapon()
+            Weapon()
         if type==&quot;world&quot;:
-            return World()
+            World()
         if type==&quot;character&quot;:
-            return Character(id, &quot;foo&quot;)
-        return None
+            Character(id, &quot;foo&quot;)
         
     def evt_game_start(self):
         &quot;&quot;&quot; Start event handler.
@@ -59,9 +40,18 @@
         &quot;&quot;&quot;
         Sun()
         
+    def evt_log_info(self, text):
+        print u&quot;[SERVER info] %s&quot; % text
+        
+    def evt_log_warning(self, text):
+        print u&quot;[SERVER warn] %s&quot; % text
+        
+    def evt_log_error(self, text):
+        print u&quot;[SERVER error] %s&quot; % text
+        
     def evt_agent_manager_Text(self, event):
         &quot;&quot;&quot; Text event handler.
         @param event: Event with &quot;agent_manager_Text&quot; type.
         @type event: C{L{common.event.Event}}
         &quot;&quot;&quot;
-        print &quot;[DISPLAY] Server message: %s&quot; %(event.content)
+        print &quot;[CLIENT] Server message: %s&quot; %(event.content)

Modified: boomboom/client/bb_display.py
===================================================================
--- boomboom/client/bb_display.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/client/bb_display.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -5,17 +5,15 @@
 @version: 0.2
 &quot;&quot;&quot;
 from happyboom.common.happyboom_protocol import HappyboomProtocol as Presentation
-from happyboom.common.event import EventLauncher, EventListener
 from happyboom.common.log import log
+from happyboom.client.base_client import Client as BaseClient
+from happyboom.common.event import EventListener
 import bb_events
 from bb_drawer import BoomBoomDrawer
 from bb_constructor import BoomBoomConstructor
-from net import io
 from happyboom.net.io import Packet
-from net import io_udp, io_tcp
-import thread
 
-class BoomBoomDisplay(EventLauncher, EventListener):
+class BoomBoomDisplay(BaseClient, EventListener):
     &quot;&quot;&quot; Class which manages &quot;display&quot; part of the network connections.
     Also creates a drawer and a constuctor for &quot;display&quot; management.
     @ivar drawer: instance which draws screen game.
@@ -26,21 +24,9 @@
     @type port: C{int}
     @ivar name: Name of the client (as known by the server).
     @type name: C{str}
-    @ivar __protocol_version: Current version of the protocol used by the client.
-    @type __protocol_version: C{str}
-    @ivar __io: Network input/output object using UDP protocole.
-    @type __io: C{net.io_udp.IO_UDP}
-    @ivar __verbose: Verbose mode flag.
-    @type __verbose: C{bool}
-    @ivar __debug: Debug mode flag.
-    @type __debug: C{bool}
-    @ivar __stopped: Stopped display client flag.
-    @type __stopped: C{bool}
-    @ivar __stoplock: Mutex for synchronizing __stopped.
-    @type __stoplock: C{thread.lock}
     &quot;&quot;&quot;
     
-    def __init__(self, protocol, arg):
+    def __init__(self, arg):
         &quot;&quot;&quot; BoomBoomDisplay constructor.
         @param host: Server hostname.
         @type host: C{str}
@@ -55,102 +41,40 @@
         @param max_fps: Maximal number of frames per second, for optimization.
         @type max_fps: C{int}
         &quot;&quot;&quot;
-        EventLauncher.__init__(self)
-        EventListener.__init__(self, prefix=&quot;evt_&quot;)
-        self.presentation = Presentation(protocol)
+
+        EventListener.__init__(self)
+        BaseClient.__init__(self, arg)
         self.drawer = BoomBoomDrawer(arg.get(&quot;max_fps&quot;, 25))
-        self.host = arg.get(&quot;host&quot;, &quot;localhost&quot;)
-        self.port = arg.get(&quot;port&quot;, 12430)
         self.name = arg.get(&quot;name&quot;, &quot;no name&quot;)
-        self.__protocol = protocol
-        self.__io = io_tcp.IO_TCP()
-        self.__verbose = arg.get(&quot;verbose&quot;, False)
-        self.__io.verbose = self.__verbose
-        self.__debug = arg.get(&quot;debug&quot;, False)
-        self.__io.debug = self.__debug
-        self.__stopped = False
-        self.__stoplock = thread.allocate_lock()
-        
-        self.registerEvent(&quot;weapon&quot;)
+        #TODO: Support chat?
+        self.gateway.features = [&quot;game&quot;, &quot;character&quot;, &quot;projectile&quot;, &quot;weapon&quot;, &quot;world&quot;, &quot;log&quot;]
         self.registerEvent(&quot;happyboom&quot;)
-        self.launchEvent(&quot;happyboom&quot;, &quot;register&quot;, &quot;connection&quot;, self.onConnection)
-        self.launchEvent(&quot;happyboom&quot;, &quot;register&quot;, &quot;disconnection&quot;, self.onDisconnection)
 
-    def onConnection(self, ioclient, version, signature):
-        # TODO: Save signature to reuse it later
-        features = &quot;TODO: Feed me!&quot;
-        if self.__verbose: log.info(&quot;Connected to server, send features ...&quot;)
-        self.launchEvent(&quot;happyboom&quot;, &quot;features&quot;, self.__io, features)
-    
-    def onDisconnection(self, ioclient, reason):
-        log.warning(u&quot;Received disconnected from server: %s&quot; % reason)
-        self.launchEvent(&quot;game&quot;, &quot;stop&quot;)
-        
+    def evt_happyboom_netSendMsg(self, feature, event, *args):
+        self.send(feature, event, *args)
+
     def start(self):
         &quot;&quot;&quot; Starts the display client : connection to the server, etc. &quot;&quot;&quot;
-        # Try to connect to server
-        if self.__verbose: print &quot;[DISPLAY] Trying to connect to server %s:%u&quot; % (self.host, self.port)
-        self.__io.on_connect = self.onConnect
-        self.__io.on_connection_fails = self.onConnectionFails
-        self.__io.on_disconnect = self.onDisconnect
-        self.__io.on_new_packet = self.presentation.processPacket
-        self.__io.on_lost_connection = self.onLostConnection
-        self.__io.connect(self.host, self.port)
-        if not self.__io.is_ready: return
-        thread.start_new_thread(self.__io.run_thread, ())
+        BaseClient.start(self)
     
         BoomBoomConstructor()
-        self.launchEvent(&quot;happyboom&quot;, &quot;connection&quot;, self.__io, self.__protocol.version.encode(&quot;ascii&quot;), &quot;&quot;)
         print &quot;==== BoomBoom ====&quot;
         self.drawer.start()
         
     def stop(self):
         &quot;&quot;&quot; Stops the display client : disconnection from the server, etc. &quot;&quot;&quot;
-        self.__stoplock.acquire()
-        self.__stopped = True
-        self.__stoplock.release()
-        # TODO: clean &quot;bye&quot;
-        self.launchEvent(&quot;happyboom&quot;, &quot;disconnection&quot;, self.__io, u&quot;Quit.&quot;)
-        self.__io.stop()
-        if self.__verbose: print &quot;[DISPLAY] Stopped&quot;
-        
-    def setIoSendReceive(self, on_send, on_receive):
-        &quot;&quot;&quot; Set new handler functions for I/O network.
-        @param on_send: Handler called for sending data.
-        @type C{function}
-        @param on_receive: Handler called for receiving data.
-        @type C{function}
-        &quot;&quot;&quot;
-        self.__io.on_send = on_send
-        self.__io.on_receive = on_receive
-        
-    def onConnect(self):
-        &quot;&quot;&quot; Handler called on network connection. &quot;&quot;&quot;
-        if self.__verbose: print &quot;[DISPLAY] Connected to server&quot;
-        
-    def onConnectionFails(self):
-        &quot;&quot;&quot; Handler called when network connection fails. &quot;&quot;&quot;
-        print &quot;[DISPLAY] Fail to connect to the server&quot;
+        if not BaseClient.stop(self): return
+        self.launchEvent(&quot;happyboom&quot;, &quot;disconnection&quot;, self._io, u&quot;Quit.&quot;)
+        self._io.stop()
+        if self.verbose: print &quot;[CLIENT] Stopped&quot;
 
-    def onDisconnect(self):
-        &quot;&quot;&quot; Handler called on network disconnection. &quot;&quot;&quot;
-        print &quot;[DISPLAY] Connection to server closed&quot;
-        self.launchEvent(&quot;game&quot;, &quot;start&quot;)
-
-    def onLostConnection(self):
-        &quot;&quot;&quot; Handler called on losting network connection. &quot;&quot;&quot;
-        print &quot;[DISPLAY] Lost connection with server&quot;
-        self.launchEvent(&quot;game&quot;, &quot;stop&quot;)
-    
-    def send(self, feature, event, *args):
-        &quot;&quot;&quot; Sends a string to the network server.
-        @param str: String to send.
-        @type str: C{str}
-        &quot;&quot;&quot;
-        data = self.__protocol.createMsg(feature, event, *args)
-        data = self.presentation.sendMsg(data)
-        self.__io.send(Packet(data))
-        
-    def evt_weapon_shoot(self, event):
-        print &quot;Shoot aussi&quot;
-        self.send(&quot;weapon&quot;, &quot;shoot&quot;)
+# Wass used for stats
+#    def setIoSendReceive(self, on_send, on_receive):
+#        &quot;&quot;&quot; Set new handler functions for I/O network.
+#        @param on_send: Handler called for sending data.
+#        @type C{function}
+#        @param on_receive: Handler called for receiving data.
+#        @type C{function}
+#        &quot;&quot;&quot;
+#        self._io.on_send = on_send
+#        self._io.on_receive = on_receive

Modified: boomboom/client/bb_input.py
===================================================================
--- boomboom/client/bb_input.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/client/bb_input.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -84,8 +84,7 @@
         if event.type == pygame.KEYDOWN: 
             # arrow keys: move character
             if event.key == 32:
-                print &quot;Event %s&quot; % bb_events.shoot
-                self.launchEvent(&quot;weapon&quot;, &quot;shoot&quot;)
+                self.launchEvent(&quot;happyboom&quot;, &quot;netSendMsg&quot;, &quot;weapon&quot;, &quot;shoot&quot;)
             elif event.key == 275: self.sendCmd(&quot;move_right&quot;)
             elif event.key == 273: self.sendCmd(&quot;move_up&quot;) 
             elif event.key == 274: self.sendCmd(&quot;move_down&quot;)

Modified: boomboom/client/items/character.py
===================================================================
--- boomboom/client/items/character.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/client/items/character.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -36,18 +36,16 @@
         self.__name = name
         self.visual = VisualObject(os.path.join(&quot;data&quot;, &quot;gorilla.png&quot;))
         self.active = False
-        self.registerEvent(bb_events.characterMove)
-        self.registerEvent(bb_events.activeCharacter)
+        self.registerEvent(&quot;character&quot;)
         
-    def evt_character_move(self, event):
+    def evt_character_move(self, id, x, y):
         &quot;&quot;&quot; Character move event handler.
         @param event: Event with &quot;character_move&quot; type.
         @type event: C{L{common.simple_event.Event}}
         &quot;&quot;&quot;
-        id, x, y = event.content.split(&quot;,&quot;)
-        if self.__id != int(id): return
-        self.__x = int(x)
-        self.__y = int(y)
+        if self.__id != id: return
+        self.__x = x
+        self.__y = y
         self.visual.move(self.__x, self.__y)
         if self.active:
             self.launchEvent(bb_events.activeCharAbs, self.__x)
@@ -61,4 +59,4 @@
         if self.__id == int(event.content):
             self.active = True
             if self.__x != None:
-                self.launchEvent(bb_events.activeCharAbs, self.__x)
\ No newline at end of file
+                self.launchEvent(bb_events.activeCharAbs, self.__x)

Modified: boomboom/client/items/projectile.py
===================================================================
--- boomboom/client/items/projectile.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/client/items/projectile.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -17,21 +17,17 @@
     def __init__(self):
         &quot;&quot;&quot; Projectile itemp constructor. &quot;&quot;&quot;
         BoomBoomItem.__init__(self)
-        
         self.visual = VisualObject(os.path.join(&quot;data&quot;, &quot;banana.png&quot;))
-        self.registerEvent(bb_events.projectileMove)
-        self.registerEvent(bb_events.projectileHitGround)
-        self.registerEvent(bb_events.projectileActivate)
+        self.registerEvent(&quot;projectile&quot;)
         
-    def evt_projectile_move(self, event):
+    def evt_projectile_move(self, x, y):
         &quot;&quot;&quot; Projectile move event handler.
         @param event: Event with &quot;projectile_move&quot; type.
         @type event: C{L{common.simple_event.Event}}
         &quot;&quot;&quot;
-        x, y = event.content.split(&quot;,&quot;)
-        self.visual.move(int(x), int(y))
+        self.visual.move(x, y)
         
-    def evt_projectile_hit_ground(self, event):
+    def evt_projectile_hitGround(self, x, y):
         &quot;&quot;&quot; Projectile hit ground event handler.
         @param event: Event with &quot;projectile_hit_ground&quot; type.
         @type event: C{L{common.simple_event.Event}}
@@ -39,9 +35,9 @@
         print &quot;[DISPLAY] Hit ground&quot;
         # TODO: Graphic effect
         
-    def evt_projectile_activate(self, event):
+    def evt_projectile_activate(self, state):
         &quot;&quot;&quot; Projectile activate event handler.
         @param event: Event with &quot;projectile_activate&quot; type.
         @type event: C{L{common.simple_event.Event}}
         &quot;&quot;&quot;
-        self.visual.setVisibility(event.content == '1')
+        self.visual.setVisibility(state == 1)

Modified: boomboom/client/items/weapon.py
===================================================================
--- boomboom/client/items/weapon.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/client/items/weapon.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -36,30 +36,41 @@
         self.__font_background = (0,0,0,0)
         self.__y = 10
         self.__x = 10
-        self.registerEvent(bb_events.weaponStrength)
-        self.registerEvent(bb_events.weaponAngle)
-        self.registerEvent(bb_events.activeCharAbs)
+        self.character_pos = {}
+        self.registerEvent(&quot;weapon&quot;)
+        self.registerEvent(&quot;character&quot;)
+        print self.event_manager.listeners[&quot;character&quot;]
+        self.registerEvent(&quot;game&quot;)
+#        self.registerEvent(bb_events.activeCharAbs)
+
+    def eventPerformed(self, event):
+        print &quot;WTF ? &quot;, event
         
-    def evt_weapon_force(self, event):
+    def evt_weapon_setStrength(self, strength):
         &quot;&quot;&quot; Weapon strength event handler.
         @param event: Event with &quot;weapon_force&quot; type.
         @type event: C{L{common.simple_event.Event}}
         &quot;&quot;&quot;
-        self.__strength = int(event.content)
+        self.__strength = strength
         
-    def evt_weapon_angle(self, event):
+    def evt_weapon_setAngle(self, angle):
         &quot;&quot;&quot; Weapon angle event handler.
         @param event: Event with &quot;weapon_angle&quot; type.
         @type event: C{L{common.simple_event.Event}}
         &quot;&quot;&quot;
-        self.__angle = int(event.content)
+        self.__angle = angle 
+
+    def evt_charactr_move(self, id, x, y):
+        print &quot;move *** %s,%s&quot; % (x,y)
+        self.character_pos[id] = (x, y,)
         
-    def evt_active_character_abscisse(self, event):
+    def evt_game_setActiveCharacter(self, id):
         &quot;&quot;&quot; Active character abcsisse event handler.
         @param event: Event with &quot;active_character_abscisse&quot; type.
         @type event: C{L{common.simple_event.Event}}
         &quot;&quot;&quot;
-        self.__x = int(event.content)
+        print &quot;active *** %s&quot; % (id)
+        self.__x = self.character_pos[id][0]
         
     def draw(self, screen):
         &quot;&quot;&quot; Drawing method called by C{BoomBoomDrawer}
@@ -70,4 +81,4 @@
         if self.__strength == None: return
         txt = &quot;Angle: %s  Strength: %s&quot; % (self.__angle, self.__strength)
         surface = self.__font.render(txt, True, self.__font_color, self.__font_background)
-        screen.blit(surface, (self.__x,self.__y))
\ No newline at end of file
+        screen.blit(surface, (self.__x,self.__y))

Modified: boomboom/client/items/world.py
===================================================================
--- boomboom/client/items/world.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/client/items/world.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -48,15 +48,20 @@
         &quot;&quot;&quot; World item constructor. &quot;&quot;&quot;
         BoomBoomItem.__init__(self)
         self.__buildings = []
-        self.registerEvent(bb_events.worldCreate)
+        self.registerEvent(&quot;world&quot;)
 
-    def evt_world_create(self, event):
+    def born(self):
+        Agent.born(self)
+        self.registerAction(&quot;world&quot;)
+
+    def evt_world_create(self, data):
         &quot;&quot;&quot; World create event handler.
         @param event: Event with &quot;world_create&quot; type.
         @type event: C{L{common.simple_event.Event}}
         &quot;&quot;&quot;
+        print &quot;Create world.&quot;
         self.__buildings = []
-        rects = event.content.split(&quot;;&quot;)
+        rects = data.split(&quot;;&quot;)
         for rect in rects:
             x, y, w, h = rect.split(&quot;,&quot;)
             b = Building(int(x), int(y), int(w), int(h))
@@ -67,4 +72,4 @@
         @param screen: Offscreen to draw in.
         @type screen: C{L{Window&lt;bb_drawer.Window&gt;}}
         &quot;&quot;&quot;
-        for b in self.__buildings: b.draw(screen)
\ No newline at end of file
+        for b in self.__buildings: b.draw(screen)

Modified: boomboom/protocol.xml
===================================================================
--- boomboom/protocol.xml	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/protocol.xml	2005-09-16 04:42:34 UTC (rev 183)
@@ -9,7 +9,25 @@
     &lt;event name=&quot;nextTurn&quot; id=&quot;4&quot; /&gt;
   &lt;/feature&gt;
   
-  &lt;feature name=&quot;character&quot; id=&quot;2&quot;&gt;
+  &lt;feature name=&quot;log&quot; id=&quot;2&quot;&gt;
+    &lt;event name=&quot;info&quot; id=&quot;1&quot;&gt;
+      &lt;param type=&quot;utf8&quot; name=&quot;text&quot; /&gt;
+    &lt;/event&gt;
+    &lt;event name=&quot;warning&quot; id=&quot;2&quot;&gt;
+      &lt;param type=&quot;utf8&quot; name=&quot;text&quot; /&gt;
+    &lt;/event&gt;
+    &lt;event name=&quot;error&quot; id=&quot;3&quot;&gt;
+      &lt;param type=&quot;utf8&quot; name=&quot;text&quot; /&gt;
+    &lt;/event&gt;
+  &lt;/feature&gt;  
+
+  &lt;feature name=&quot;chat&quot; id=&quot;3&quot;&gt;
+    &lt;event name=&quot;message&quot; id=&quot;1&quot;&gt;
+      &lt;param type=&quot;utf8&quot; name=&quot;text&quot; /&gt;
+    &lt;/event&gt;
+  &lt;/feature&gt;  
+
+  &lt;feature name=&quot;character&quot; id=&quot;4&quot;&gt;
     &lt;event name=&quot;move&quot; id=&quot;1&quot;&gt;
       &lt;param type=&quot;int&quot; name=&quot;id&quot; /&gt;
       &lt;param type=&quot;int&quot; name=&quot;x&quot; /&gt;
@@ -17,14 +35,21 @@
     &lt;/event&gt;
   &lt;/feature&gt;
   
-  &lt;feature name=&quot;projectile&quot; id=&quot;3&quot;&gt;
+  &lt;feature name=&quot;projectile&quot; id=&quot;5&quot;&gt;
     &lt;event name=&quot;activate&quot; id=&quot;1&quot;&gt;
       &lt;param type=&quot;int&quot; name=&quot;on&quot; /&gt;
     &lt;/event&gt;
-    &lt;event name=&quot;hitGround&quot; id=&quot;2&quot; /&gt;
+    &lt;event name=&quot;move&quot; id=&quot;2&quot;&gt;
+      &lt;param type=&quot;int&quot; name=&quot;x&quot; /&gt;
+      &lt;param type=&quot;int&quot; name=&quot;y&quot; /&gt;
+    &lt;/event&gt;
+    &lt;event name=&quot;hitGround&quot; id=&quot;3&quot;&gt;
+      &lt;param type=&quot;int&quot; name=&quot;x&quot; /&gt;
+      &lt;param type=&quot;int&quot; name=&quot;y&quot; /&gt;
+    &lt;/event&gt;
   &lt;/feature&gt;
   
-  &lt;feature name=&quot;weapon&quot; id=&quot;4&quot;&gt;
+  &lt;feature name=&quot;weapon&quot; id=&quot;6&quot;&gt;
     &lt;event name=&quot;shoot&quot; id=&quot;1&quot; /&gt;
     &lt;event name=&quot;setAngle&quot; id=&quot;2&quot;&gt;
       &lt;param type=&quot;int&quot; name=&quot;angle&quot; /&gt;
@@ -34,9 +59,9 @@
     &lt;/event&gt;
   &lt;/feature&gt;
   
-  &lt;feature name=&quot;chat&quot; id=&quot;5&quot;&gt;
-    &lt;event name=&quot;message&quot; id=&quot;1&quot;&gt;
-      &lt;param type=&quot;utf8&quot; name=&quot;text&quot; /&gt;
+  &lt;feature name=&quot;world&quot; id=&quot;7&quot;&gt;
+    &lt;event name=&quot;create&quot; id=&quot;1&quot;&gt;
+      &lt;param type=&quot;bin&quot; name=&quot;buildings&quot; /&gt;
     &lt;/event&gt;
   &lt;/feature&gt;
 &lt;/protocol&gt;

Modified: boomboom/server/agents/__init__.py
===================================================================
--- boomboom/server/agents/__init__.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/server/agents/__init__.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -1,3 +1,4 @@
+from log import LogAgent
 from projectile import Projectile
 from weapon import Weapon
 from world import World
@@ -2,2 +3,2 @@
 from character import Character
-from game import Game
\ No newline at end of file
+from game import Game

Modified: boomboom/server/agents/character.py
===================================================================
--- boomboom/server/agents/character.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/server/agents/character.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -10,6 +10,7 @@
         self.team = team
         self.next = False
         self.current = False
+        self.registerEvent(&quot;gateway&quot;)
         
     def born(self):
         Agent.born(self)
@@ -23,12 +24,11 @@
         if self.x == x and self.y == y and not force: return
         self.x = x
         self.y = y
-        self.sendBroadcast(Message(&quot;character_move&quot;, (&quot;%u,%i,%i&quot; % (self.id, self.x, self.y),)), &quot;network&quot;)
-        if self.current:
-            self.send(&quot;active_coord&quot;, self.x, self.y)
-            self.sendNetMsg(&quot;character&quot;, &quot;move&quot;, self.id, self.x, self.y)
+        self.send(&quot;move&quot;, self.id, self.x, self.y)
+        self.sendNetMsg(&quot;character&quot;, &quot;move&quot;, self.id, self.x, self.y)
 
-    def sync(self):
+    def evt_gateway_syncClient(self, client):
+        self.netCreateItem(client)
         self.move(self.x, self.y, force=True)
 
     def msg_found_place(self, x, y):
@@ -39,6 +39,3 @@
         if self.current:
             self.send(&quot;active_coord&quot;, self.x, self.y)
         self.next = False
-        
-    def msg_network_sync(self):
-        self.sync()

Modified: boomboom/server/agents/game.py
===================================================================
--- boomboom/server/agents/game.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/server/agents/game.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -6,26 +6,23 @@
         Agent.__init__(self, &quot;game&quot;, gateway, **args)
         self.characters = []
         self.current = None 
+        self.registerEvent(&quot;gateway&quot;)
 
     def born(self):
         Agent.born(self)
         self.requestActions(&quot;world&quot;)
         self.requestActions(&quot;network&quot;)
 
-    def msg_network_sync(self):
-        self.sync()
-
     def msg_new_character(self, character):
         self.characters.append(character)
         if self.current == None:
             self.setCurrent(0)
 
-    def sync(self):
-        self.sendBroadcast(Message(&quot;game_current_character&quot;, self.current), &quot;network&quot;)
-
     def setCurrent(self, current):
         self.current = current
-        self.sendNetMsg(&quot;game&quot;, &quot;setActiveCharacter&quot;, current)
+        char = self.characters[self.current].id
+        self.send(&quot;setActiveCharacter&quot;, char)
+        self.sendNetMsg(&quot;game&quot;, &quot;setActiveCharacter&quot;, char)
 
     def nextCharacter(self):
         new = (self.current + 1) % len(self.characters)
@@ -34,9 +31,9 @@
     def nextTurn(self):
         self.send(&quot;next_turn&quot;)
         self.sendNetMsg(&quot;game&quot;, &quot;nextTurn&quot;)
-        self.sendNetMsg(&quot;game&quot;, &quot;setActiveCharacter&quot;, self.current)
+        self.setCurrent(self.current)
 
-    def msg_world_collision(self, x, y):
+    def msg_world_hitGround(self, x, y):
         self.nextTurn()
         self.nextCharacter()
         
@@ -46,3 +43,7 @@
     def launchGame(self):    
         self.setCurrent(self.current)
         self.nextTurn()
+
+    def evt_gateway_syncClient(self, client):
+        self.sendNetMsg(&quot;game&quot;, &quot;start&quot;)
+        self.setCurrent(self.current)

Added: boomboom/server/agents/log.py
===================================================================
--- boomboom/server/agents/log.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/server/agents/log.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -0,0 +1,23 @@
+from server.bb_agent import Agent
+from happyboom.common.log import Log, log
+import types
+
+class LogAgent(Agent):
+    def __init__(self, gateway, **args):
+        Agent.__init__(self, &quot;log&quot;, gateway, **args)
+        self.registerEvent(&quot;gateway&quot;)
+        log.on_new_message = self.onNewMessage
+
+    def onNewMessage(self, level, prefix, text):
+        if type(text) != types.UnicodeType:
+            text = unicode(text)
+        if level==Log.LOG_INFO:
+            self.sendNetMsg(&quot;log&quot;, &quot;info&quot;, text)
+        elif level==Log.LOG_INFO:
+            self.sendNetMsg(&quot;log&quot;, &quot;warning&quot;, text)
+        elif level==Log.LOG_INFO:
+            self.sendNetMsg(&quot;log&quot;, &quot;error&quot;, text)
+        
+    def evt_gateway_syncClient(self, client):
+        # Send last messages?
+        pass

Modified: boomboom/server/agents/projectile.py
===================================================================
--- boomboom/server/agents/projectile.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/server/agents/projectile.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -9,11 +9,14 @@
         self.x, self.y = 0, 0
         self.start_pos = None
         self.active = False
+        self.active_character = None
         self.time = None
         self.speed = None
         self.weapon_angle = None
         self.weapon_strength = None
         self.mass = 10
+        self.registerEvent(&quot;gateway&quot;)
+        self.registerEvent(&quot;weapon&quot;)
 
     def born(self):
         Agent.born(self)
@@ -31,28 +34,32 @@
     def msg_weapon_angle(self, angle):
         self.weapon_angle = (-int(angle)) * math.pi / 180
 
-    def msg_weapon_shoot(self, cmd):
+    def msg_weapon_shoot(self):
         if not self.active:
             self.shoot()
 
-    def msg_character_active_coord(self, x, y):
-        self.start_pos = (x, y)
+    def msg_game_setActiveCharacter(self, id):
+        self.active_character = id
 
-    def msg_world_collision(self, x, y):
+    def msg_character_move(self, id, x, y):
+        if self.active_character == id:
+            self.start_pos = (x, y) 
+
+    def msg_world_hitGround(self, x, y):
         self.setActive(False)
 
     def setActive(self, active):
         self.active = active
-        self.sendBBMessage(&quot;activate&quot;, active)
-        self.sendNetMsg(&quot;projectile&quot;, &quot;activate&quot;, 0) 
+        self.send(&quot;activate&quot;, active)
+        self.sendNetMsg(&quot;projectile&quot;, &quot;activate&quot;, int(active)) 
 
     def shoot(self):
-        log.info(&quot;Shoot!&quot;)
         if self.weapon_angle==None: return
         if self.weapon_strength==None: return
         if self.start_pos==None: return
         self.move(self.start_pos[0], self.start_pos[1])
         self.setActive(True)
+
         self.time = time.time()
         sx = self.weapon_strength * math.cos(self.weapon_angle)
         sy = self.weapon_strength * math.sin(self.weapon_angle)
@@ -63,8 +70,8 @@
     def move(self, x, y):
         self.x = x
         self.y = y
-        self.sendBBMessage(&quot;move&quot;, x, y)
-        self.sendNetMsg(&quot;projectile&quot;, &quot;move&quot;, x, y)
+        self.send(&quot;move&quot;, x, y)
+        self.sendNetMsg(&quot;projectile&quot;, &quot;move&quot;, int(x), int(y))
 
     def live(self):
         Agent.live(self)
@@ -74,8 +81,9 @@
             y = self.start_pos[1] +self.speed[1] * dt +9.8*dt*dt*self.mass
             self.move (x, y)
 
-    def sync(self, client):
-        # TODO: Only send it to client
+    def evt_gateway_syncClient(self, client):
+        self.netCreateItem(client)
+        self.move(self.x, self.y)
         self.setActive(self.active)
 
     def msg_gateway_syncClient(self, client):

Modified: boomboom/server/agents/weapon.py
===================================================================
--- boomboom/server/agents/weapon.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/server/agents/weapon.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -8,6 +8,7 @@
         self.last_values = {}
         self.currentTeam = None
         self.nextTeam = None
+        self.registerEvent(&quot;gateway&quot;)
 
     def born(self):
         Agent.born(self)
@@ -26,16 +27,6 @@
         self.updateAngle(angle)
         self.updateStrength(strength)
 
-    def msg_new_command(self, cmd):
-        if cmd == &quot;move_left&quot;:
-            self.updateStrength (self.strength - 5)
-        if cmd == &quot;move_right&quot;:
-            self.updateStrength (self.strength + 5)
-        if cmd == &quot;move_down&quot;:
-            self.updateAngle (self.angle - 5)
-        if cmd == &quot;move_up&quot;:
-            self.updateAngle (self.angle + 5)
-
     def updateAngle(self, angle):
         if angle &lt; -80: angle = -80
         elif 80 &lt; angle: angle = 80
@@ -50,9 +41,7 @@
         self.send(&quot;strength&quot;, strength)
         self.sendNetMsg(&quot;weapon&quot;, &quot;setStrength&quot;, strength)
 
-    def sync(self):
+    def evt_gateway_syncClient(self, client):
+        self.netCreateItem(client)
         self.updateStrength(self.strength)
         self.updateAngle(self.angle)
-
-    def msg_network_sync(self):
-        self.sync()

Modified: boomboom/server/agents/world.py
===================================================================
--- boomboom/server/agents/world.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/server/agents/world.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -26,13 +26,13 @@
         self.buildings = None
         self.height = 350
         self.width = 640
+        self.registerEvent(&quot;gateway&quot;)
         self.generate()
 
     def born(self):
         Agent.born(self)
         self.requestActions(&quot;projectile&quot;)
         self.requestActions(&quot;game&quot;)
-        self.requestActions(&quot;network&quot;)
         self.sendBroadcastMessage(Message(&quot;new_item&quot;, (self.type, self.id)), &quot;network&quot;)
 
     def generate(self):
@@ -65,13 +65,14 @@
                 return True
         return False    
 
-    def sync(self):
+    def sync(self, client):
         msg = &quot;&quot;
         for b in self.buildings:
             if len(msg) != 0: msg = msg + &quot;;&quot;
             msg = msg + &quot;%i,%i,%i,%i&quot; % (b.x, b.y, b.width, b.height)
         self.sendBroadcastMessage(Message(&quot;world_create&quot;, (msg,)), &quot;network&quot;)
-        self.sendNetMsg(&quot;world&quot;, &quot;create&quot;, m)
+        self.netCreateItem(client)
+        self.sendNetMsg(&quot;world&quot;, &quot;create&quot;, msg)
 
     def msg_character_search_place(self, x0, width, height):
         if x0 &lt; 0:
@@ -90,8 +91,8 @@
                 
     def msg_projectile_move(self, x, y):
         if self.hitGround(x, y):
-            self.sendBBMessage(&quot;collision&quot;, x, y)
-            self.sendNetMsg(&quot;projectile&quot;, &quot;hitGround&quot;)
+            self.send(&quot;hitGround&quot;, x, y)
+            self.sendNetMsg(&quot;projectile&quot;, &quot;hitGround&quot;, int(x), int(y))
 
-    def msg_network_sync(self):
-        self.sync()
+    def evt_gateway_syncClient(self, client):
+        self.sync(client)

Modified: boomboom/server/bb_server.py
===================================================================
--- boomboom/server/bb_server.py	2005-09-16 04:41:41 UTC (rev 182)
+++ boomboom/server/bb_server.py	2005-09-16 04:42:34 UTC (rev 183)
@@ -5,7 +5,7 @@
     ClientManager
 from pysma import Kernel
 from bb_agent import Message
-from agents import Character, Projectile, Weapon, World, Game
+from agents import Character, Projectile, Weapon, World, Game, LogAgent
 from happyboom.common.log import log
 
 class Gateway(HBGateway):
@@ -23,6 +23,7 @@
     def start(self):
         HBGateway.start(self)
         if self._verbose: log.info(&quot;[*] Creating agents&quot;)
+        self.addAgent(LogAgent(self, debug=self._debug))
         self.addAgent(Game(self, debug=self._debug))
         self.addAgent(World(self, debug=self._debug))
         self.addAgent(Character(self, 100, 1, debug=self._debug))


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000089.html">[Happyboom-svn] r182 - in happyboom/trunk: client common server
</A></li>
	<LI>Next message: <A HREF="000091.html">[Happyboom-svn] r184 - boomboom boomboom/client boomboom/client/items boomboom/server boomboom/server/agents happyboom/trunk/client happyboom/trunk/common happyboom/trunk/server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#90">[ date ]</a>
              <a href="thread.html#90">[ thread ]</a>
              <a href="subject.html#90">[ subject ]</a>
              <a href="author.html#90">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/happyboom-svn">More information about the Happyboom-svn
mailing list</a><br>
</body></html>
